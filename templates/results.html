<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis Results</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        h1 {
            margin-bottom: 20px;
        }

        .results-container {
            margin-bottom: 20px;
        }

        .result-item {
            margin-bottom: 10px;
        }

        #map {
            height: 400px;
            width: 100%;
            margin-bottom: 20px;
        }

        #back-button {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1em;
            cursor: pointer;
            z-index: 1000;
        }

        #back-button:hover {
            background-color: #0056b3;
        }

        #glidepath-plot {
            max-width: 100%;
            height: 500px;
            margin-top: 20px;
        }
    </style>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
    <h1>Analysis Results</h1>

    <div class="results-container">
        <div class="result-item"><strong>Initial Latitude:</strong> {{ initial_latitude }}</div>
        <div class="result-item"><strong>Initial Longitude:</strong> {{ initial_longitude }}</div>
        <div class="result-item"><strong>Final Latitude:</strong> {{ final_latitude }}</div>
        <div class="result-item"><strong>Final Longitude:</strong> {{ final_longitude }}</div>
        <div class="result-item"><strong>Final Velocity:</strong> {{ finalv|round(3) }} m/s</div>
        <div class="result-item"><strong>Fall Time:</strong> {{ falltime|round(3) }} s</div>
        <div class="result-item"><strong>Ground Distance:</strong> {{ distancetravelled }} m</div>
        <div class="result-item"><strong>Final Kinetic Energy:</strong> {{ final_kinetic_energy }} J</div>
    </div>

    <div id="map"></div>

    <!-- 3D Glide Path Plot -->
    <div id="glidepath-plot"></div>

    <!-- Back to Forms Button -->
    <button id="back-button" onclick="window.location.href='/'">Back to Forms</button>

    <script>
        function initMap() {
            // Initial and final coordinates
            const initialLatLng = [{{ initial_latitude }}, {{ initial_longitude }}];
            const finalLatLng = [{{ final_latitude }}, {{ final_longitude }}];

            // Create the map centered on the initial location
            const map = L.map('map').setView(initialLatLng, 12);

            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Marker for initial location
            L.marker(initialLatLng).addTo(map)
                .bindPopup('Initial Location')
                .openPopup();

            // Marker for final location
            L.marker(finalLatLng).addTo(map)
                .bindPopup('Final Location')
                .openPopup();

            // Draw a line between the initial and final locations
            L.polyline([initialLatLng, finalLatLng], {color: 'red'}).addTo(map);

            // Extract and convert horizontal coordinates from the 3D glide path
            var dxv = {{ dxv | safe }};
            var dyv = {{ dyv | safe }};
            var dzv = {{ dzv | safe }};

            // Simple projection: assume dxv represents latitude changes and dyv represents longitude changes
            var horizontalPath = dxv.map((x, i) => [
                {{ initial_latitude }} + x * 0.00001, // Adjust scale factor as needed
                {{ initial_longitude }} + dyv[i] * 0.00001 // Adjust scale factor as needed
            ]);

            // Draw the projected path on the map
            L.polyline(horizontalPath, {color: 'blue', weight: 2}).addTo(map);
        }

        // Initialize map
        document.addEventListener('DOMContentLoaded', function () {
            initMap();
        });

        // Round values to three decimal places
        function roundToThreeDecimals(arr) {
            return arr.map(val => parseFloat(val.toFixed(3)));
        }

        // 3D Glide Path Plot with Plotly
        var dxv = {{ dxv | safe }};
        var dyv = {{ dyv | safe }};
        var dzv = {{ dzv | safe }};

        // Round the values
        dxv = roundToThreeDecimals(dxv);
        dyv = roundToThreeDecimals(dyv);
        dzv = roundToThreeDecimals(dzv);

        var trace1 = {
            x: dxv,
            y: dyv,
            z: dzv,
            mode: 'lines',
            type: 'scatter3d',
            line: {
                width: 6,
                color: 'blue'
            }
        };

        var data = [trace1];

        var layout = {
            title: '3D Glide Path',
            scene: {
                xaxis: { title: 'X (Horizontal Distance)' },
                yaxis: { title: 'Y (Cross-track Distance)' },
                zaxis: { title: 'Z (Altitude)' },
            }
        };

        Plotly.newPlot('glidepath-plot', data, layout);
    </script>
</body>
</html>
